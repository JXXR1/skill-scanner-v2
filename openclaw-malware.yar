/*
 * OpenClaw Malware Detection Rules
 * YARA signatures for common skill-based threats
 * Author: JXXR1
 * Version: 1.0.0
 * License: MIT
 */

rule OpenClaw_Infostealer {
    meta:
        description = "Detects infostealers targeting OpenClaw workspace files"
        author = "JXXR1"
        date = "2026-02-18"
        severity = "critical"
    strings:
        $workspace1 = "SOUL.md" ascii
        $workspace2 = "IDENTITY.md" ascii
        $workspace3 = "MEMORY.md" ascii
        $workspace4 = "AGENTS.md" ascii
        $target1 = ".openclaw/workspace" ascii
        $exfil1 = "pastebin.com" ascii
        $exfil2 = "discord.com/api/webhooks" ascii
        $exfil3 = "telegram.org/bot" ascii
    condition:
        (2 of ($workspace*)) and ($target1) and (1 of ($exfil*))
}

rule CryptoMiner_Generic {
    meta:
        description = "Generic cryptocurrency miner detection"
        author = "JXXR1"
        severity = "critical"
    strings:
        $miner1 = "xmrig" ascii nocase
        $miner2 = "stratum+tcp://" ascii
        $miner3 = "--donate-level" ascii
        $miner4 = "cryptonight" ascii nocase
        $miner5 = "randomx" ascii nocase
        $pool1 = "pool.minexmr.com" ascii
        $pool2 = "xmr-" ascii
        $coin1 = "monero" ascii nocase
    condition:
        2 of ($miner*) or (1 of ($miner*) and 1 of ($pool*)) or (2 of ($pool*))
}

rule ReverseShell_Generic {
    meta:
        description = "Common reverse shell patterns"
        author = "JXXR1"
        severity = "critical"
    strings:
        $rs1 = "bash -i >& /dev/tcp/" ascii
        $rs2 = "nc -e /bin/bash" ascii
        $rs3 = "socket.connect" ascii
        $rs4 = "python -c 'import socket" ascii
        $rs5 = "perl -e 'use Socket" ascii
        $rs6 = "/dev/tcp/" ascii
        $rs7 = "socat exec" ascii
    condition:
        any of them
}

rule Obfuscated_PowerShell {
    meta:
        description = "Detects obfuscated PowerShell (cross-platform threat)"
        author = "JXXR1"
        severity = "high"
    strings:
        $ps1 = "powershell" ascii nocase
        $ps2 = "-enc" ascii nocase
        $ps3 = "-e " ascii
        $ps4 = "FromBase64String" ascii
        $obf1 = /[A-Za-z0-9+\/]{100,}={0,2}/ ascii
    condition:
        (1 of ($ps*)) and ($obf1)
}

rule SSH_Backdoor {
    meta:
        description = "SSH backdoor or unauthorized key injection"
        author = "JXXR1"
        severity = "critical"
    strings:
        $ssh1 = "authorized_keys" ascii
        $ssh2 = "ssh-rsa AAAA" ascii
        $ssh3 = "echo " ascii
        $ssh4 = ">> " ascii
        $sus1 = "crontab" ascii
        $sus2 = "curl" ascii
    condition:
        ($ssh1 and $ssh2 and $ssh3 and $ssh4) or ($ssh1 and 2 of ($sus*))
}

rule Fileless_Malware {
    meta:
        description = "Fileless/memory-only malware indicators"
        author = "JXXR1"
        severity = "high"
    strings:
        $mem1 = "memfd_create" ascii
        $mem2 = "/dev/shm/" ascii
        $mem3 = "/proc/self/exe" ascii
        $mem4 = ":memory:" ascii
        $code1 = "exec" ascii
        $code2 = "eval" ascii
    condition:
        (1 of ($mem*)) and (1 of ($code*))
}

rule Persistence_Mechanism {
    meta:
        description = "Linux persistence mechanisms"
        author = "JXXR1"
        severity = "high"
    strings:
        $p1 = "crontab -e" ascii
        $p2 = "/etc/rc.local" ascii
        $p3 = ".bashrc" ascii
        $p4 = ".profile" ascii
        $p5 = "/etc/systemd/system/" ascii
        $p6 = "autostart" ascii
        $write1 = "echo " ascii
        $write2 = "cat >" ascii
    condition:
        (2 of ($p*)) and (1 of ($write*))
}

rule WebShell_PHP {
    meta:
        description = "PHP webshell detection"
        author = "JXXR1"
        severity = "critical"
    strings:
        $php = "<?php" ascii
        $exec1 = "eval(" ascii
        $exec2 = "system(" ascii
        $exec3 = "exec(" ascii
        $exec4 = "shell_exec(" ascii
        $exec5 = "passthru(" ascii
        $input1 = "$_GET" ascii
        $input2 = "$_POST" ascii
        $input3 = "$_REQUEST" ascii
    condition:
        $php and (1 of ($exec*)) and (1 of ($input*))
}

rule Typosquatting_NPM {
    meta:
        description = "Common npm package typosquatting patterns"
        author = "JXXR1"
        severity = "critical"
    strings:
        $typo1 = "reqests" ascii
        $typo2 = "requsts" ascii
        $typo3 = "expresss" ascii
        $typo4 = "pythno" ascii
        $typo5 = "lodsh" ascii
        $typo6 = "mongose" ascii
    condition:
        any of them
}

rule PrivEsc_Exploit {
    meta:
        description = "Privilege escalation exploit patterns"
        author = "JXXR1"
        severity = "critical"
    strings:
        $pe1 = "pkexec" ascii
        $pe2 = "CVE-202" ascii
        $pe3 = "exploit" ascii nocase
        $pe4 = "setuid" ascii
        $pe5 = "chmod 777" ascii
        $pe6 = "chown root" ascii
        $code = "system(" ascii
    condition:
        (2 of ($pe*)) and $code
}
